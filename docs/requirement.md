# 開発生産性可視化OSS 要件定義書

## 概要

本プロジェクトは、GitHub Organization に所属する全 Repository の活動データを収集・集計し、開発チームおよび個人単位の開発生産性を可視化するための **API および CLI ツール**を開発するものである。
取得対象には commit、Pull Request、コード変更量（追加・削除）、デプロイ等を含み、API を通じてデータを提供し、CLI コマンドにより可視化・確認できることを目的とする。
Web UI は本プロジェクトのスコープ外とし、利用者が任意の UI を構築できるようにする。
本ツールは OSS（オープンソースソフトウェア）として公開される前提とする。

## 目的・背景

* 開発チームの生産性を定量的に把握できていない
* 個人およびチームの活動が Repository 単位に分散している
* マネジメント・振り返り・改善に利用できる共通指標が存在しない

これらの課題を解決するため、GitHub 上の開発活動を横断的に収集・可視化する。

## 想定ユーザ

* 開発者
* テックリード
* エンジニアリングマネージャ
* DevOps / Platform エンジニア
* OSS 利用者（外部）

## 前提・仮定（Assumptions）

* GitHub を主たる開発基盤としている
* Organization 単位でのデータ取得が可能である
* GitHub API / Webhook / GitHub Actions 等の公式手段を利用する
* 生産性指標は「評価」ではなく「可視化」を主目的とする
* **本システムはローカル環境で完結して動作することを基本とし、初期実装では SQLite をローカルキャッシュとして利用する**
* **将来的な運用拡張として、外部 RDBMS（例: PostgreSQL）と接続可能な構成を許容する**

## ユーザストーリー

### ストーリー1: 開発状況を把握したいマネージャ

* **である** エンジニアリングマネージャとして
* **私は** チームや個人の開発活動量を一覧で把握したい
* **そうすることで** 課題発見や改善施策に活かしたい

### ストーリー2: 自身の活動を振り返りたい開発者

* **である** 開発者として
* **私は** 自分の commit や PR 活動を時系列で確認したい
* **そうすることで** 自己改善や説明責任を果たしたい

## 機能要件（EARS記法）

※ 本システムは **API を中核**とし、CLI はその公式クライアント実装とする。

### 通常要件（SHALL）

* REQ-001: システムは指定された GitHub Organization に所属する全 Repository の一覧を取得しなければならない
* REQ-002: システムは Repository ごとの commit 情報を取得しなければならない
* REQ-003: システムは Repository ごとの Pull Request 情報（作成数・作成者・状態）を取得しなければならない
* REQ-004: システムは commit に含まれるコード変更量（追加行数・削除行数）を集計しなければならない
* REQ-005: システムは デプロイ情報（GitHub Actions 等）を取得可能な範囲で集計しなければならない
* REQ-006: システムは 取得・集計した結果を API 経由で取得可能にしなければならない
* REQ-007: システムは API により Organization / Repository / Member 単位で集計結果を提供しなければならない
* REQ-008: システムは 時系列（日・週・月）で集計結果を取得可能にしなければならない
* REQ-009: システムは CLI コマンドを通じて API を利用し、集計結果を可視化しなければならない

### 条件付き要件（WHEN / IF-THEN）

* REQ-101: Organization へのアクセス権限が不足している場合、システムはエラーメッセージを表示しなければならない
* REQ-102: Repository が private の場合、適切な権限を持つトークンが設定されていればデータを取得しなければならない
* REQ-103: デプロイ情報が GitHub Actions 等から取得可能な場合、システムはデプロイ回数を集計しなければならない

### 状態要件（WHERE）

* REQ-201: API レートリミットに達している状態では、システムは処理を一時停止またはリトライ制御しなければならない

### オプション要件（MAY）

* REQ-301: システムは CSV / JSON 形式でデータをエクスポートしてもよい
* REQ-302: システムは 複数 Organization を切り替えて表示してもよい
* REQ-303: システムは CLI の出力形式（表形式 / JSON / グラフ簡易表示）を切り替えられてもよい

### 制約要件（MUST）

* REQ-401: システムは GitHub の利用規約および API 利用制限を遵守しなければならない
* REQ-402: システムは OSS として公開可能なライセンス構成でなければならない
* REQ-403: システムは 個人アクセストークン等の秘密情報をコードベースに含めてはならない
* REQ-404: システムは **デフォルト構成において外部データベースや常駐サーバを必須としない** 設計でなければならない

## API要件（インタフェース観点）

### API提供方針

* API は HTTP ベースで提供されなければならない
* API は JSON 形式でレスポンスを返却しなければならない
* API は将来の互換性を考慮し、バージョニングされなければならない

### 主要エンドポイント（概念）

* GET /orgs/{org}/repos/metrics
* GET /orgs/{org}/members/metrics
* GET /orgs/{org}/repos/{repo}/metrics

※ 詳細なスキーマ定義は別途 API 仕様書で定義する

---

## CLI要件

### 通常要件（SHALL）

* CLI-001: CLI は API エンドポイントを指定して実行できなければならない
* CLI-002: CLI は Organization 名を引数として受け取らなければならない
* CLI-003: CLI は メンバー別・Repository 別の集計結果を表示しなければならない
* CLI-004: CLI は 表形式での標準出力をサポートしなければならない

### オプション要件（MAY）

* CLI-101: CLI は JSON 出力モードをサポートしてもよい
* CLI-102: CLI は 集計期間（日付範囲）を引数で指定できてもよい

---

## データ永続化要件

### 通常要件（SHALL）

* DATA-001: システムは GitHub API から取得した生データおよび集計結果を **ローカルストレージにキャッシュとして保存** しなければならない
* DATA-002: ローカルキャッシュは **SQLite を用いて単一ファイルとして管理** されなければならない
* DATA-003: ローカルキャッシュは削除可能であり、削除後は GitHub API から再構築できなければならない

### 条件付き要件（IF-THEN）

* DATA-101: 利用者が外部データベース接続情報を設定した場合、システムは SQLite の代わりに **PostgreSQL 等の RDBMS を利用してもよい**
* DATA-102: 外部データベースを利用する場合でも、システムの API および CLI の振る舞いは変更されてはならない

### 制約要件（MUST）

* DATA-201: 永続化層は抽象化されており、ストレージ実装の差異が上位レイヤに影響しない設計でなければならない

---

## 永続化レイヤ設計（Storage Layer Design）

本章では、本システムにおけるデータ永続化レイヤの設計方針および構成を定義する。
本レイヤは **SQLite をデフォルト実装**としつつ、**PostgreSQL を公式にサポート可能な拡張先**として設計される。

### 設計方針

* 永続化レイヤは API / CLI / 集計ロジックから完全に分離されなければならない
* 上位レイヤは RDBMS の種別を意識してはならない
* SQLite と PostgreSQL は同一の論理スキーマを共有する
* SQLite はローカルキャッシュ用途、PostgreSQL は運用・集約用途を想定する

---

### 論理レイヤ構成

```
[ GitHub API ]
      ↓
[ Collector / Normalizer ]
      ↓
[ Storage Interface ]  ← ← ← ← ← ← ← ← ← ← ← ← ←
      ↓                                   ↑
[ SQLite Adapter ]                [ PostgreSQL Adapter ]
      ↓                                   ↑
[ Local Cache File ]             [ External RDBMS ]
```

---

### Storage Interface（抽象化要件）

* STORAGE-001: 永続化レイヤは Storage Interface を通じて操作されなければならない
* STORAGE-002: Storage Interface は以下の操作を最低限提供しなければならない

  * saveRawEvent(event)
  * saveAggregatedMetric(metric)
  * getMetricsByOrg(org, range)
  * getMetricsByMember(org, member, range)
  * getMetricsByRepo(org, repo, range)
* STORAGE-003: 上位レイヤは SQL 方言やトランザクション管理を直接扱ってはならない

---

### スキーマ設計方針（共通）

* event 系テーブルと metric 系テーブルを分離する
* 生データ（raw）と集計データ（aggregated）を論理的に分離する
* PostgreSQL 利用時のみインデックス・パーティショニング最適化を許容する

---

### SQLite 実装要件

* SQLITE-001: SQLite は単一ファイルとして管理されなければならない
* SQLITE-002: CLI 実行時に自動生成・自動マイグレーションされなければならない
* SQLITE-003: 破損または削除時は再生成可能でなければならない

---

### PostgreSQL 実装要件

* PG-001: PostgreSQL は明示的な設定が与えられた場合のみ使用されなければならない
* PG-002: 接続情報は環境変数または設定ファイルで与えられなければならない
* PG-003: PostgreSQL 利用時も API / CLI の挙動は SQLite 利用時と同一でなければならない
* PG-004: PostgreSQL 利用時は複数プロセスからの同時アクセスを考慮してもよい

---

### マイグレーション方針

* DB スキーマはコードベースで一元管理されなければならない
* SQLite / PostgreSQL の差分はマイグレーション層で吸収されなければならない
* 破壊的変更が発生した場合でも、再構築手段が提供されなければならない

---

## 非機能要件

### パフォーマンス

* NFR-001: Organization 配下に 500 Repository が存在しても初回集計が実用時間内（例: 数分）で完了しなければならない

### セキュリティ

* NFR-101: 認証情報は環境変数または安全な設定手段で管理されなければならない

### 可用性・保守性

* NFR-201: 新しい GitHub イベント種別が追加された場合、容易に拡張できる構造でなければならない

### OSS品質

* NFR-301: README にセットアップ方法・利用方法が明記されていなければならない
* NFR-302: 外部コントリビュータが参加可能な構成でなければならない

## Edgeケース

### エラー処理

* EDGE-001: 一部 Repository の取得に失敗した場合でも、他 Repository の処理は継続されなければならない

### 境界値

* EDGE-101: commit 数が 0 のメンバーも表示対象に含まれなければならない

## 非機能要件

### パフォーマンス

* NFR-001: API は 1 Organization あたりの主要メトリクス取得を実用的な応答時間で返却しなければならない

### セキュリティ

* NFR-101: API は GitHub トークンを直接外部に露出させない設計でなければならない

### 保守性・拡張性

* NFR-201: 新しいメトリクス種別を追加する際、既存 API に影響を与えず拡張できなければならない

### OSS品質

* NFR-301: API / CLI 双方に最低限のテストが含まれていなければならない
* NFR-302: Contribution Guide が用意されていなければならない

---

## 受け入れ基準（Acceptance Criteria）

### 機能

* [ ] Organization を指定すると全 Repository のデータが取得される
* [ ] メンバーごとの commit / PR / コード変更量が確認できる
* [ ] 時系列グラフまたは一覧で可視化される

### 非機能

* [ ] README の手順通りにセットアップできる
* [ ] OSS として公開可能な状態である

---

※ 本要件定義は初期ドラフトであり、今後の詳細設計・技術選定により更新されることを前提とする
